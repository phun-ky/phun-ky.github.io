--- 
layout: posttitle: "squid log parser"description: ""category: "undefined" tags: [] --- <p>I was twisting my head trying to figure the best way to fetch data from the squid log server for a new internal statistic project at work, when I decided to make a parser myself rather than trying to find a pre-made parser and adjust it to fit my needs. After over 4 different prototypes getting a no-go from our DBA - the script had to insert rows in intervals - I finally made myself and the DBA happy.</p> <p>The script is free to use, but please keep the copyright.</p><br/><pre class="brush: php"><br/>/**<br/>        * File for parsing squid logs<br/>        *<br/>        * This file fetches lines from the squid log on the squid server and parsing the data to a mysql database<br/>        * link http://phun-ky.net/2007/03/squid-log-parser<br/>        * author Alexander Vassbotn RÃ¸yne <br/>        * license Creative Commons, see http://phun-ky.net/license for more information<br/>        * version 1.1<br/>        * name UMedia SquidParser 1.1<br/>        */<br/>        /**<br/>         * Uncheck for error checking<br/>         */<br/>        #ini_set(error_reporting(E_ALL ^ E_NOTICE),0);<br/>        #ini_set('display_errors', 1);<br/>       /**<br/>        * Connects to the database<br/>        */<br/>        $con = mysql_connect("127.0.0.1", 'username', 'password');<br/>        if (!$con) {<br/>             die("Could not connect: " . mysql_error());<br/>        }<br/>        mysql_select_db('databasename');<br/>        $log = 'tail -f /path/to/squid/access.log 2>&1';<br/>        $handle = popen($log, 'r');<br/>        $replace = array('www.','.no');<br/>        $lastMinute = date('i');<br/>        while(!feof($handle)){<br/>               $line = fgets($handle);<br/>               /**<br/>                * A very simple preg_match() to get the desired chunks, could be made better and more safe<br/>                */<br/>               preg_match ('/http:\/\/(\S*)\/\S* \S* \S* (\S*) /iU' , $line, $chunks);<br/>               $host = str_replace($replace,'',$chunks[1]);<br/>               $sites[$host] += $chunks[2];<br/>               $minute = date('i');<br/>               settype($minute, 'integer');<br/>               /**<br/>                * This script is set to fetch the bytes and add them up, insert them in the database each 5 minutes<br/>                * The script was intended on a system with log rotation each 2 hours, so some quirks was made to start<br/>                * it again when the file was renamed.<br/>                */<br/>               if((($minute%5) == 0) && ($lastMinute != date('i'))){<br/>                    $lastMinute = date('i');<br/>                    settype($lastMinute, 'integer');<br/>                    foreach($sites as $site => $bytes){<br/>                            $sql = 'INSERT INTO tableName VALUES ( ''.$site.'',''.$bytes.'',''.date('Y-m-d H:i:s').'')';<br/>                            echo $sql.'\n';<br/>                            mysql_query($sql, $con);<br/>                    }<br/>                    unset($sites);<br/>                    unset($sql);<br/>               }<br/>        }<br/>        pclose($handle);<br/>        mysql_close($con);
</pre>