--- 
layout: posttitle: "How to add a search feature to your blog for cakephp"description: ""category: "undefined" tags: [] --- I was looking for a decent search feature to add to  my blog, and after some reading around, I found this feature very easy and interesting. I found a <a href="http://bakery.cakephp.org/articles/view/search-feature-to-cakephp-blog-example">how to in the bakery</a>, but as several users pointed out, it lacked simplicity and a reindex feature. I kept it to the basics and hope this will work as easy for you as it did for me.<br/><h2>Step 1: Download Searchable Behaviour</h2><br/>Download the latest <a href="http://code.google.com/p/searchable-behaviour-for-cakephp/" rel="nofollow">Searchable Behaviour from here</a> and upload the contents to your app/models directory.<br/><h2>Step 2: Create Table For Indexes</h2><br/>Notice that We've added UNIQUE to the key 'association_key'.<br/><pre class="brush: sql"><br/>CREATE TABLE `search_index` (<br/>        `id` int(11) NOT NULL auto_increment,<br/>        `association_key` varchar(36) NOT NULL,<br/>        `model` varchar(128) collate utf8_unicode_ci NOT NULL,<br/>        `data` longtext collate utf8_unicode_ci NOT NULL,<br/>        `created` datetime NOT NULL,<br/>        `modified` datetime NOT NULL,<br/>        PRIMARY KEY  (`id`),<br/>        UNIQUE KEY `association_key` (`association_key`,`model`),<br/>        FULLTEXT KEY `data` (`data`)<br/>) ENGINE=MyISAM  DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;<br/></pre><br/><br/><h2>Step 3: Add SearchIndex Model</h2><br/><pre class="brush: php"><br/>&lt;?php<br/>class SearchIndex extends AppModel {<br/>  var $name = 'SearchIndex';<br/> var $useTable = 'search_index';<br/>  private $models = array();<br/><br/>  private function bindTo($model) {<br/>    $this->bindModel( <br/>     array(<br/>       'belongsTo' => array(<br/>          $model => array (<br/>            'className' => $model,<br/>           'conditions' => 'SearchIndex.model = \''.$model.'\'',<br/>            'foreignKey' => 'association_key'<br/>          )<br/>        )<br/>      ),false <br/>   );<br/> }<br/>  <br/> <br/> function searchModels($models = array()) {<br/>   if (is_string($models)) $models = array($models);<br/>    $this->models = $models;<br/>   foreach ($models as $model) {<br/>      $this->bindTo($model);<br/>   }<br/>  }<br/>    <br/> function beforeFind($queryData) {<br/>    $models_condition = false;<br/>   if (!empty($this->models)) {<br/>     $models_condition = array();<br/>     foreach ($this->models as $model) {<br/>        $Model = ClassRegistry::init($model);<br/>        $models_condition[] = $model . '.'.$Model->primaryKey.' IS NOT NULL'; <br/>     }<br/>    }<br/>    <br/>   if (isset($queryData['conditions'])) {<br/>     if ($models_condition) {<br/>       if (is_string($queryData['conditions'])) {<br/>         $queryData['conditions'] .= ' AND (' . join(' OR ',$models_condition) . ')';<br/>       } else {<br/>         $queryData['conditions'][] = array('OR' => $models_condition);<br/>       }<br/>      }<br/>    } else {<br/>     if ($models_condition) {<br/>       $queryData['conditions'][] = array('OR' => $models_condition);<br/>     }<br/>    }<br/>    return $queryData;  <br/> }<br/>}<br/>?><br/></pre><br/><h2>Step 4: Update Your Post Model</h2><br/>We want to make the model Searchable and to have a minimal of validation of the fields.<br/><pre class="brush: php">  <br/> var $actsAs   = array('Searchable');  <br/> var $validate = array(<br/>   'title' => array(<br/>      'rule' => array('minLength', 1)<br/>    ),<br/>     'text' => array(<br/>       'rule' => array('minLength', 1)<br/>    )<br/>  ); <br/></pre><br/><h2>Step 5: Add Actions In Your Post Controller</h2><br/><pre class="brush: php"><br/> function search() {<br/>    $this->set('results', $this->Post->search($this->data['Post']['q']));<br/>    $this->set('query',$this->data['Post']['q']);<br/>  }   <br/></pre><br/><br/><h2>Step 6: Add Search Input Field</h2><br/>Just add this wherever you want your users to search from. <br/><pre class="brush: php"><br/>&lt;?php <br/>    echo $form->create("Post",array('action' => 'search'));<br/>    echo $form->input("q",'label' => 'Search'));<br/>    echo $form->end("Search");<br/>?>  <br/></pre><br/><h2>Step 7: Add search.ctp</h2><br/>Here  you can see that I've added some nice higlightning and excerpts to the results.<br/><pre class="brush: php"><br/><h1><br/> Search results &lt;?php if(!empty($query)){ echo 'for &lt;em>"' . $query . '"&lt;/em>';} ?><br/></h1><br/>&lt;?php foreach ($results as $post): ?><br/>&lt;div style="" class="searchResultHolder curved-5"><br/> &lt;?php echo '&lt;a style="font-size:14px;text-transform:capitalize;" href="/' . date('Y',$post['Post']['published']) . '/' . date('m',$post['Post']['published']) . '/' . $post['Post']['slug'] . '">' . ucfirst($post['Post']['title']) . '&lt;/a>, &lt;em>published: '.date('Y-m-d H:i:s',$post['Post']['published']).' &lt;/em>';?>&lt;br /><br/>  &lt;?php<br/>   $str = $post['Post']['text'];<br/>    $str = $text->excerpt($str, $query, 200);<br/><br/> ?><br/> &lt;div style="margin-top:5px;" class="summary">&lt;?php echo $text->highlight($str, $query);?>&lt;/div>    <br/>&lt;/div><br/>&lt;?php endforeach; ?><br/></pre><br/><br/><h2>Step 8: Update Routes</h2><br/>As a precautin, add this to routes just to safeguard that the link works.<br/><pre class="brush: php"><br/> Router::connect('/posts/search/', array('controller' => 'post', 'action' => 'search')); <br/></pre><br/><br/><h2>Step 9: Reindex Your Data</h2><br/>Per default, the new search feature you just added will not index old data. It will only index new data you add from now on. To reindex your old data, follow these steps:<br/><h2>Step 10: Add functions to your post model</h2><br/>Add these functions into your Post Model. Remember, you can change the field you want index.<br/><pre class="brush: php"><br/>        function indexData() {<br/>                $index = $this->data['Post']['text'];<br/>                return $index;<br/>        }<br/>        <br/> function reindexAll() {<br/>    if (!$this->SearchIndex) {<br/>     $this->SearchIndex = ClassRegistry::init('SearchIndex');<br/>   }<br/>    ini_set('max_execution_time', 360); // increase execution time<br/>   App::import('Model', $this->name);<br/>   $newmodel = new $this->name();<br/>   $data = $newmodel->findAll();<br/>    foreach ($data as $i=>$row) {<br/>      $newmodel->data = $row;<br/>      $index = $newmodel->indexData();<br/>     if ($index) {<br/>        $searchEntry = $this->SearchIndex->find('first', array(
             'fields'=>  array(
                'id'
              ),
              'conditions'  =>  array(
                'model' =>  $this->name,
                'association_key' =>  $row[$this->name]['id']
             )
           ));<br/>        $index_data = array(<br/>         'SearchIndex' => array(<br/>          'model' => $this->name,<br/>          'id' => empty($searchEntry) ? 0 : $searchEntry['SearchIndex']['id'],'association_key' => $row[$this->name]['id'],<br/>          'data' => $index<br/>         )<br/>        );<br/>       $res = $this->SearchIndex->save($index_data);<br/>      }<br/>    }<br/>  } <br/>        <br/></pre><br/><h2>Step 11: Add function to Post Controller</h2><br/>Add this to your Post Controller:<br/><pre class="brush: php"><br/>  function admin_reindex() { <br/>      $this->Post->reindexAll();<br/>     die();    <br/> } <br/></pre><br/>And presto! You have a fully functional search function with all your data indexed! Just remember to hide or comment out the reindex functionality after you've finished with it.